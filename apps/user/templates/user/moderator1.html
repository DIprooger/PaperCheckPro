<!DOCTYPE html>
<html lang="ru">
<head>
    <style>
        /* Стиль для основного содержимого */
        .main {
            width:   100%; /* Ширина основного содержимого равна   100% ширины окна браузера */
            padding:   20px; /* Добавить отступы для основного содержимого */
        }

        .aside {
            width:   97%; /* Ширина основного содержимого равна   100% ширины окна браузера */
            text-align: right; /* Выравнивание по правому краю */
        }

        /* Стиль для таблицы */
        table {
            width:   100%; /* Занимать всю доступную ширину родительского элемента */
            border-collapse: collapse; /* Убрать промежутки между ячейками */
        }

        th, td {
            text-align: left;
            padding:   8px;
            border:   1px solid #ddd; /* Добавить границы */
        }

        tr:nth-child(even) {background-color: #f2f2f2;}

        img {
            max-width:   100%;
            height: auto;
        }

        /* Стиль для контейнера альбома */
        .album-container {
            margin-top:   20px; /* Отступ сверху для каждого нового альбома */
        }

        /* Стиль для модального окна */
        .modal {
            display: none; /* По умолчанию скрыто */
            position: fixed; /* Оставаться на месте */
            z-index:   1; /* Находиться над всеми другими элементами */
            padding-top:   100px; /* Отступ сверху */
            left:   0;
            top:   0;
            width:   100%; /* Полная ширина */
            height:   100%; /* Полная высота */
            overflow: auto; /* Включить прокрутку */
            background-color: rgb(0,0,0); /* Черный фон с прозрачностью */
            background-color: rgba(0,0,0,0.4); /* Черный фон с прозрачностью */
        }

        /* Стиль для контента модального окна */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding:   20px;
            border:   1px solid #888;
            width:   80%;
        }
    </style>
    <script>
    function createImageTable(albumName, imagesArray) {
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var tbody = document.createElement('tbody');

        // Создаем заголовки таблицы
        var tr = document.createElement('tr');
        var th1 = document.createElement('th');
        th1.textContent = 'ФИО'; // Изменено название столбца
        var th2 = document.createElement('th');
        th2.textContent = 'Изображение'; // Изменено название столбца
        var th3 = document.createElement('th');
        th3.textContent = 'Оценка'; // Заголовок для столбца оценки
        tr.appendChild(th1);
        tr.appendChild(th2);
        tr.appendChild(th3);
        thead.appendChild(tr);
        table.appendChild(thead);

        // Создаем строки таблицы для каждого изображения
        imagesArray.forEach(function(image) {
            var tr = document.createElement('tr');
            var td1 = document.createElement('td');
            td1.textContent = image.alt; // Предполагается, что alt содержит ФИО
            tr.appendChild(td1);

            var td2 = document.createElement('td');
            var img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt;
            img.style.width = '100px'; // Устанавливаем фиксированный размер для мини-версии
            img.onclick = function() { showImage(image.src); }; // Добавляем обработчик клика для увеличения изображения
            td2.appendChild(img);
            tr.appendChild(td2);

            var td3 = document.createElement('td');
            // Оставляем этот столбец пустым, так как оценка еще не задана
            tr.appendChild(td3);

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        return table; // Возвращаем созданную таблицу
    }

        // Функция для добавления нового альбома
function addNewAlbum() {
    var albumName = prompt("Введите название альбома:");
    if (albumName !== null) {
        // Получаем выбранные значения из выпадающих списков
        var selectedSubject = document.getElementById('subject').value;
        var selectedClass = document.getElementById('class').value;

        // Здесь нужно получить ID пользователя, который создает альбом
        // Это может быть реализовано разными способами, например, через аутентификацию пользователя
        var userId =   1; // Пример ID пользователя

        // Создаем элементы для нового альбома
        var titleLabel = document.createElement('label');
        titleLabel.setAttribute('for', 'titleInput');
        titleLabel.textContent = 'Название альбома:';

        var titleInput = document.createElement('input');
        titleInput.setAttribute('type', 'text');
        titleInput.setAttribute('id', 'titleInput');
        titleInput.setAttribute('name', 'title');
        titleInput.setAttribute('placeholder', 'Введите название');
        titleInput.setAttribute('value', albumName);
        titleInput.setAttribute('readonly', true);

        // Создаем элемент для отображения даты создания альбома
        var dateLabel = document.createElement('label');
        dateLabel.textContent = 'Дата создания: ' + new Date().toLocaleDateString();

        var addButton = document.createElement('button');
        addButton.textContent = 'Добавить работы';
        addButton.onclick = function() { addNewWork(this.parentNode); };

        var deleteAlbumButton = document.createElement('button');
        deleteAlbumButton.textContent = 'Удалить альбом';
        deleteAlbumButton.onclick = function() { deleteAlbum(this.parentNode); };

        // Создаем кнопку "Проверить"
        var checkButton = document.createElement('button');
        checkButton.textContent = 'Проверить';
        checkButton.onclick = function() { checkImages(this.parentNode); };

        // Создаем контейнер для нового альбома
        var albumContainer = document.createElement('div');
        albumContainer.className = 'album-container'; // Добавляем класс для стилизации
        albumContainer.setAttribute('data-subject', selectedSubject); // Используем выбранный предмет
        albumContainer.setAttribute('data-class', selectedClass); // Используем выбранный класс
        albumContainer.appendChild(titleLabel);
        albumContainer.appendChild(titleInput);
        albumContainer.appendChild(dateLabel); // Добавляем элемент с датой создания
        albumContainer.appendChild(addButton);
        albumContainer.appendChild(deleteAlbumButton);
        albumContainer.appendChild(checkButton); // Добавляем кнопку "Проверить"

        // Создаем таблицу для нового альбома
        var table = createImageTable(albumName, []);
        albumContainer.appendChild(table);

        // Добавляем контейнер с новым альбомом в начало основного контейнера альбомов
        var mainContainer = document.getElementById('albumsContainer');
        if (mainContainer.firstChild) {
            mainContainer.insertBefore(albumContainer, mainContainer.firstChild);
        } else {
            mainContainer.appendChild(albumContainer);
        }

        // Отправляем запрос на сервер для создания нового альбома
        fetch('/api/create_album/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': csrftoken, // Если используете CSRF защиту
            },
            body: JSON.stringify({
                name: albumName,
                user_id: userId,
                subject: selectedSubject, // Отправляем выбранный предмет
                class: selectedClass // Отправляем выбранный класс
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            // Здесь можно обновить интерфейс пользователя, например, добавить новый альбом в список
            // В данном случае, интерфейс уже обновлен, так как мы добавляли альбом в DOM до отправки запроса
        })
        .catch((error) => {
            console.error('Error:', error);
            // Здесь можно обработать ошибку, например, удалить созданный элемент из DOM
            mainContainer.removeChild(albumContainer);
        });

        saveAlbumsToLocalStorage(); // Сохраняем изменения
    }
}




    async function checkImages(albumContainer) {
        // Получаем все изображения из альбома
        const images = albumContainer.querySelectorAll('img');

        for (const image of images) {
            // Получаем ID работы студента для текущего изображения
            // Предполагается, что у изображения есть атрибут data-student-work-id с ID работы
            const studentWorkId = image.dataset.studentWorkId;

            // Отправляем запрос на сервер для декодирования изображения
            const decodeResponse = await fetch('/api/decode-image/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: studentWorkId }),
            });

            if (decodeResponse.ok) {
                const decodeResult = await decodeResponse.json();
                console.log('Изображение декодировано:', decodeResult);

                // Отправляем запрос на сервер для генерации текста
                const textResponse = await fetch('/api/response-text/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: studentWorkId }),
                });

                if (textResponse.ok) {
                    const textResult = await textResponse.json();
                    console.log('Текст сгенерирован:', textResult);

                    // Здесь вы можете обновить интерфейс, чтобы показать результаты
                    // Например, обновить столбец "Оценка" в таблице альбома
                } else {
                    console.error('Ошибка при генерации текста:', textResponse.statusText);
                }
            } else {
                console.error('Ошибка при декодировании изображения:', decodeResponse.statusText);
            }
        }
    }


        // Функция для добавления работы в альбом
        function addNewWork(albumContainer, studentName) {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true; // Позволяем выбрать несколько файлов
        input.onchange = function(e) {
            var files = e.target.files;
            for (var i =  0; i < files.length; i++) {
                var file = files[i];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = { src: e.target.result, alt: studentName }; // Используем ФИО вместо имени файла
                    // Обновляем таблицу с изображениями
                    var table = albumContainer.querySelector('table');
                    if (table) {
                        var tr = document.createElement('tr');
                        var td1 = document.createElement('td');
                        td1.textContent = img.alt; // Используем ФИО
                        tr.appendChild(td1);

                        var td2 = document.createElement('td');
                        var imgElement = document.createElement('img');
                        imgElement.src = img.src;
                        imgElement.alt = img.alt;
                        imgElement.style.width = '100px'; // Устанавливаем фиксированный размер для мини-версии
                        imgElement.onclick = function() { showImage(img.src); }; // Добавляем обработчик клика для увеличения изображения
                        td2.appendChild(imgElement);
                        tr.appendChild(td2);

                        var td3 = document.createElement('td');
                        // Оставляем этот столбец пустым, так как оценка еще не задана
                        tr.appendChild(td3);

                        table.appendChild(tr);
                    }
                    // Сохраняем изменения в localStorage
                    saveAlbumsToLocalStorage();
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }


        // Функция для отображения изображения в модальном окне
        function showImage(src) {
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("img01");
            modalImg.src = src;
            modal.style.display = "block";
        }

        // Функция для закрытия модального окна
        function closeModal() {
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
        }

        // Функция для удаления альбома
        function deleteAlbum(albumContainer) {
            var albumsContainer = document.getElementById('albumsContainer');
            albumsContainer.removeChild(albumContainer); // Удаляем контейнер альбома из DOM

            // Удаляем альбом из localStorage
            var albums = JSON.parse(localStorage.getItem('albums')) || [];
            var albumName = albumContainer.querySelector('input[name="title"]').value;
            var index = albums.findIndex(album => album.name === albumName);
            if (index !== -1) {
                albums.splice(index,  1); // Удаляем альбом из массива
                localStorage.setItem('albums', JSON.stringify(albums)); // Сохраняем обновленный массив в localStorage
            }
            saveAlbumsToLocalStorage(); // Обновляем localStorage после удаления

        }

// Функция для сохранения альбомов в localStorage
function saveAlbumsToLocalStorage() {
    var albums = [];
    var albumContainers = document.querySelectorAll('.album-container');
    albumContainers.forEach(function(container) {
        var albumName = container.querySelector('input[name="title"]').value;
        var images = [];
        var imgElements = container.querySelectorAll('img');
        imgElements.forEach(function(img) {
            images.push({ src: img.src, alt: img.alt });
        });
        albums.push({ name: albumName, images: images });
    });
    localStorage.setItem('albums', JSON.stringify(albums));
}




        // Функция для загрузки альбомов из localStorage
    function loadAlbumsFromLocalStorage() {
        var albums = JSON.parse(localStorage.getItem('albums')) || [];
        albums.forEach(function(album) {
            var albumContainer = document.createElement('div');
            albumContainer.className = 'album-container';

            var titleLabel = document.createElement('label');
            titleLabel.setAttribute('for', 'titleInput');
            titleLabel.textContent = 'Название альбома:';

            var titleInput = document.createElement('input');
            titleInput.setAttribute('type', 'text');
            titleInput.setAttribute('id', 'titleInput');
            titleInput.setAttribute('name', 'title');
            titleInput.setAttribute('placeholder', 'Введите название');
            titleInput.setAttribute('value', album.name);
            titleInput.setAttribute('readonly', true);

            var dateLabel = document.createElement('label');
            // Убедитесь, что дата создания корректно загружается из localStorage
            dateLabel.textContent = 'Дата создания: ' + (album.creationDate || 'Неизвестно');

            var addButton = document.createElement('button');
            addButton.textContent = 'Добавить работы';
            addButton.onclick = function() { addNewWork(this.parentNode); };

            var deleteAlbumButton = document.createElement('button');
            deleteAlbumButton.textContent = 'Удалить альбом';
            deleteAlbumButton.onclick = function() { deleteAlbum(this.parentNode); };

            albumContainer.appendChild(titleLabel);
            albumContainer.appendChild(titleInput);
            albumContainer.appendChild(dateLabel); // Добавляем элемент с датой создания
            albumContainer.appendChild(addButton);
            albumContainer.appendChild(deleteAlbumButton);

            var table = createImageTable(album.name, album.images || []);
            albumContainer.appendChild(table);

            var mainContainer = document.getElementById('albumsContainer');
            mainContainer.appendChild(albumContainer);
        });
    }

    // Вызываем функцию при загрузке страницы
    window.onload = function() {
        loadAlbumsFromLocalStorage();
        filterAlbums(); // Применяем фильтрацию сразу после загрузки страницы
    };

    function createAlbum(albumName, userId) {
        fetch('/api/create_album/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': csrftoken, // Если используете CSRF защиту
            },
            body: JSON.stringify({
                name: albumName,
                user_id: userId,
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            // Здесь можно обновить интерфейс пользователя, например, добавить новый альбом в список
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

// Функция для фильтрации альбомов по выбранному предмету и классу
function filterAlbums() {
    var selectedSubject = document.getElementById('subject').value;
    var selectedClass = document.getElementById('class').value;

    var albumContainers = document.querySelectorAll('.album-container');
    albumContainers.forEach(function(container) {
        var albumSubject = container.getAttribute('data-subject');
        var albumClass = container.getAttribute('data-class');

        if (albumSubject === selectedSubject && albumClass === selectedClass) {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    });
}


        // Функция для отображения списка людей
function displayPeopleList(subject, classValue) {
    // Создаем ключ для фильтра
    var filterKey = subject + classValue;

    // Отправляем запрос на сервер для получения списка людей
    fetch('/api/people?subject=' + subject + '&class=' + classValue)
        .then(response => response.json())
        .then(data => {
            // Очистка контейнера для списка
            var peopleContainer = document.getElementById('peopleContainer');
            peopleContainer.innerHTML = '';

            // Отображение списка людей
            data.forEach(function(person) {
                var personElement = document.createElement('div');
                personElement.textContent = person.name + ', ' + person.age + ' лет';
                peopleContainer.appendChild(personElement);
            });
        })
        .catch(error => console.error('Ошибка при получении списка людей:', error));
}


function saveAlbumToServer(album) {
    // Преобразуем объект альбома в строку JSON
    var albumJson = JSON.stringify(album);

    // Отправляем запрос на сервер
    fetch('/api/albums', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: albumJson,
    })
    .then(response => response.json())
    .then(data => {
        console.log('Альбом успешно сохранен:', data);
    })
    .catch((error) => {
        console.error('Ошибка при сохранении альбома:', error);
    });
}


                // Функция для отображения изображения в модальном окне
        function showImage(src) {
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("img01");
            modalImg.src = src;
            modal.style.display = "block";
        }

    </script>
</head>
<body>
    <div class="aside">
        <input type="text" placeholder="Имя"> <br>
        <input type="text" placeholder="Фамилия">
    </div>
    <div class="main">
       <label for="subject">Предмет:</label>
        <select name="subject" id="subject" onchange="filterAlbums()">
            <option value="math">Математика</option>
            <option value="physics">Физика</option>

            <!-- Другие варианты предметов -->
        </select>
        <label for="class">Класс:</label>
        <select name="class" id="class" onchange="filterAlbums()">
            <option value="5">5 класс</option>
            <option value="6">6 класс</option>
            <option value="7">7 класс</option>
            <option value="8">8 класс</option>
            <option value="9">9 класс</option>
            <option value="10">10 класс</option>
        </select>
        <br><br>
        <button onclick="addNewAlbum()">Добавить альбом</button><br>
        <br><br><br>
        <div id="albumsContainer">
        </div>
        <br><br>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal()" class="close">&times;</span>
            <img id="img01" alt="" style="width:100%;">
        </div>
    </div>

    <script>
        window.onload = function() {
            loadAlbumsFromLocalStorage();
        };
    </script>
</body>
</html>